{% extends "base.html" %}

{% block title %}{{ _('pages.settings.title') }} - CodeInsight{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
{% endblock %}

{% block content %}
<div class="toast-container" id="toast-container"></div>

<div class="settings-container">
    <div class="settings-layout">
        <!-- Sidebar -->
        <div class="settings-sidebar">
            <nav class="settings-nav nav">
                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <ul class="nav-links">
                        <li><a href="#profile" class="nav-link active" data-section="profile"><i class="fas fa-user"></i><span>Profile</span></a></li>
                        <li><a href="#account" class="nav-link" data-section="account"><i class="fas fa-cog"></i><span>Account</span></a></li>
                    </ul>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Preferences</div>
                    <ul class="nav-links">
                        <li><a href="#privacy" class="nav-link" data-section="privacy"><i class="fas fa-eye"></i><span>Privacy</span></a></li>
                        <li><a href="#notifications" class="nav-link" data-section="notifications"><i class="fas fa-bell"></i><span>Notifications</span></a></li>
                        <li><a href="#integrations" class="nav-link" data-section="integrations"><i class="fas fa-plug"></i><span>Integrations</span></a></li>
                    </ul>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Danger</div>
                    <ul class="nav-links">
                        <li><a href="#danger" class="nav-link" data-section="danger"><i class="fas fa-exclamation-triangle"></i><span>Danger Zone</span></a></li>
                    </ul>
                </div>
            </nav>
        </div>

        <!-- Content -->
        <div class="settings-content">
            <!-- Profile Section -->
            <div class="settings-section active" id="profile-section">
                <!-- Avatar Card -->
                <div class="settings-card">
                    <div class="settings-header">
                        <h2 class="settings-title">Profile Picture</h2>
                        <p class="settings-description">Choose how your avatar appears across CodeInsight</p>
                    </div>
                    <div class="settings-body">
                        <div class="avatar-section">
                            <div class="avatar-preview-container">
                                <div class="avatar-preview" id="avatar-preview" style="background: {{ current_user.get_letter_avatar_color() }};">
                                    {% if current_user.avatar_source != 'letter' and current_user.get_avatar_url() %}
                                        <img src="{{ current_user.get_avatar_url() }}" alt="Avatar">
                                    {% else %}
                                        {{ current_user.username[0].upper() }}
                                    {% endif %}
                                </div>
                                <button type="button" class="btn btn-outline btn-sm" onclick="removeAvatar()">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </div>
                            <div class="avatar-options">
                                <div class="avatar-source-grid">
                                    {% if current_user.has_github() %}
                                    <button type="button" class="avatar-source-btn github {{ 'active' if current_user.avatar_source == 'github' }}" data-source="github">
                                        <i class="fab fa-github"></i>
                                        <span>GitHub</span>
                                        <i class="fas fa-check check"></i>
                                    </button>
                                    {% endif %}
                                    {% if current_user.has_gitlab() %}
                                    <button type="button" class="avatar-source-btn gitlab {{ 'active' if current_user.avatar_source == 'gitlab' }}" data-source="gitlab">
                                        <i class="fab fa-gitlab"></i>
                                        <span>GitLab</span>
                                        <i class="fas fa-check check"></i>
                                    </button>
                                    {% endif %}
                                    {% if current_user.has_bitbucket() %}
                                    <button type="button" class="avatar-source-btn bitbucket {{ 'active' if current_user.avatar_source == 'bitbucket' }}" data-source="bitbucket">
                                        <i class="fab fa-bitbucket"></i>
                                        <span>Bitbucket</span>
                                        <i class="fas fa-check check"></i>
                                    </button>
                                    {% endif %}
                                    <button type="button" class="avatar-source-btn letter {{ 'active' if current_user.avatar_source == 'letter' }}" data-source="letter">
                                        <i class="fas fa-font"></i>
                                        <span>Letter Avatar</span>
                                        <i class="fas fa-check check"></i>
                                    </button>
                                    {% if current_user.custom_avatar %}
                                    <button type="button" class="avatar-source-btn custom {{ 'active' if current_user.avatar_source == 'custom' }}" data-source="custom">
                                        <i class="fas fa-image"></i>
                                        <span>Custom</span>
                                        <i class="fas fa-check check"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                <div class="avatar-upload-zone" id="avatar-upload-zone" onclick="document.getElementById('avatar-input').click()">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p>Click to upload a custom avatar (max 2MB)</p>
                                </div>
                                <input type="file" id="avatar-input" accept="image/jpeg,image/png,image/gif,image/webp" style="display:none;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Info Card -->
                <div class="settings-card">
                    <div class="settings-header">
                        <h2 class="settings-title">Profile Information</h2>
                        <p class="settings-description">Update your personal details</p>
                    </div>
                    <div class="settings-body">
                        <form id="profile-form">
                            <div class="form-group">
                                <label class="form-label">
                                    Username
                                    {% if not current_user.can_change_username() %}
                                    <span class="cooldown-badge"><i class="fas fa-clock"></i> {{ current_user.days_until_username_change() }} days</span>
                                    {% endif %}
                                </label>
                                <div class="form-inline">
                                    <div class="form-group">
                                        <input type="text" id="username" class="form-control" value="{{ current_user.username }}" 
                                            {{ 'disabled' if not current_user.can_change_username() }} maxlength="30">
                                    </div>
                                    <button type="button" class="btn btn-secondary" id="change-username-btn" 
                                        {{ 'disabled' if not current_user.can_change_username() }} onclick="changeUsername()">
                                        Change
                                    </button>
                                </div>
                                <div class="form-help">You can change your username once every 7 days</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <div class="form-inline">
                                    <div class="form-group">
                                        <input type="email" id="email" class="form-control" value="{{ current_user.email or '' }}" placeholder="your@email.com">
                                    </div>
                                    <button type="button" class="btn btn-secondary" onclick="requestEmailChange()">Change</button>
                                </div>
                                <div class="form-help">A verification code will be sent to the new email</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="bio">Bio</label>
                                <textarea id="bio" class="form-control" rows="3" maxlength="500" placeholder="Tell us about yourself...">{{ current_user.bio or '' }}</textarea>
                                <div class="form-help"><span id="bio-count">{{ (current_user.bio or '')|length }}</span>/500 characters</div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="website">Website</label>
                                    <input type="url" id="website" class="form-control" value="{{ current_user.website or '' }}" placeholder="https://example.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="location">Location</label>
                                    <input type="text" id="location" class="form-control" value="{{ current_user.location or '' }}" placeholder="City, Country" maxlength="100">
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary" id="save-profile-btn">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Account Section -->
            <div class="settings-section" id="account-section">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2 class="settings-title">Connected Accounts</h2>
                        <p class="settings-description">Manage your connected OAuth providers</p>
                    </div>
                    <div class="settings-body">
                        <!-- GitHub -->
                        <div class="account-item">
                            <div class="account-info">
                                <div class="account-icon github"><i class="fab fa-github"></i></div>
                                <div class="account-details">
                                    <h4>GitHub</h4>
                                    <p>Access your GitHub repositories</p>
                                </div>
                            </div>
                            <div class="account-status">
                                {% if current_user.has_github() %}
                                <span class="status-badge connected">Connected</span>
                                {% if current_user.can_disconnect_github() %}
                                <a href="{{ url_for('auth.disconnect_github') }}" class="btn btn-outline btn-sm" onclick="return confirm('Disconnect GitHub?')">Disconnect</a>
                                {% endif %}
                                {% else %}
                                <span class="status-badge disconnected">Not Connected</span>
                                <a href="{{ url_for('auth.github_login', link=1) }}" class="btn btn-primary btn-sm">Connect</a>
                                {% endif %}
                            </div>
                        </div>

                        <!-- GitLab -->
                        <div class="account-item">
                            <div class="account-info">
                                <div class="account-icon gitlab"><i class="fab fa-gitlab"></i></div>
                                <div class="account-details">
                                    <h4>GitLab</h4>
                                    <p>Access your GitLab repositories</p>
                                </div>
                            </div>
                            <div class="account-status">
                                {% if current_user.has_gitlab() %}
                                <span class="status-badge connected">Connected</span>
                                {% if current_user.can_disconnect_gitlab() %}
                                <a href="{{ url_for('gitlab_auth.disconnect_gitlab') }}" class="btn btn-outline btn-sm" onclick="return confirm('Disconnect GitLab?')">Disconnect</a>
                                {% endif %}
                                {% else %}
                                <span class="status-badge disconnected">Not Connected</span>
                                <a href="{{ url_for('gitlab_auth.gitlab_login', link=1) }}" class="btn btn-primary btn-sm">Connect</a>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Bitbucket -->
                        <div class="account-item">
                            <div class="account-info">
                                <div class="account-icon bitbucket"><i class="fab fa-bitbucket"></i></div>
                                <div class="account-details">
                                    <h4>Bitbucket</h4>
                                    <p>Access your Bitbucket repositories</p>
                                </div>
                            </div>
                            <div class="account-status">
                                {% if current_user.has_bitbucket() %}
                                <span class="status-badge connected">Connected</span>
                                {% if current_user.can_disconnect_bitbucket() %}
                                <a href="{{ url_for('bitbucket_auth.disconnect_bitbucket') }}" class="btn btn-outline btn-sm" onclick="return confirm('Disconnect Bitbucket?')">Disconnect</a>
                                {% endif %}
                                {% else %}
                                <span class="status-badge disconnected">Not Connected</span>
                                <a href="{{ url_for('bitbucket_auth.bitbucket_login', link=1) }}" class="btn btn-primary btn-sm">Connect</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preferences -->
                <div class="settings-card">
                    <div class="settings-header">
                        <h2 class="settings-title">Preferences</h2>
                        <p class="settings-description">Customize your experience</p>
                    </div>
                    <div class="settings-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="language">Language</label>
                                <select id="language" class="form-control" onchange="updatePreference('language', this.value)">
                                    <option value="en" {{ 'selected' if current_user.language == 'en' }}>English</option>
                                    <option value="ar" {{ 'selected' if current_user.language == 'ar' }}>العربية</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="timezone">Timezone</label>
                                <select id="timezone" class="form-control" onchange="updatePreference('timezone', this.value)">
                                    <option value="UTC" {{ 'selected' if current_user.timezone == 'UTC' }}>UTC</option>
                                    <option value="America/New_York" {{ 'selected' if current_user.timezone == 'America/New_York' }}>Eastern Time (ET)</option>
                                    <option value="America/Los_Angeles" {{ 'selected' if current_user.timezone == 'America/Los_Angeles' }}>Pacific Time (PT)</option>
                                    <option value="Europe/London" {{ 'selected' if current_user.timezone == 'Europe/London' }}>London (GMT)</option>
                                    <option value="Europe/Paris" {{ 'selected' if current_user.timezone == 'Europe/Paris' }}>Paris (CET)</option>
                                    <option value="Asia/Dubai" {{ 'selected' if current_user.timezone == 'Asia/Dubai' }}>Dubai (GST)</option>
                                    <option value="Asia/Tokyo" {{ 'selected' if current_user.timezone == 'Asia/Tokyo' }}>Tokyo (JST)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Privacy Section -->
            <div class="settings-section" id="privacy-section">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2 class="settings-title">Privacy Settings</h2>
                        <p class="settings-description">Control your profile visibility and data sharing</p>
                    </div>
                    <div class="settings-body">
                        <div class="toggle-group">
                            <div class="toggle-info">
                                <h4>Public Profile</h4>
                                <p>Allow others to view your profile at /u/{{ current_user.username }}</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-input" id="public-profile" 
                                    {{ 'checked' if current_user.public_profile }} onchange="updatePrivacy('public_profile', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="toggle-group">
                            <div class="toggle-info">
                                <h4>Show Private Repositories</h4>
                                <p>Include private repositories in your public profile stats</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-input" id="publish-private-repos" 
                                    {{ 'checked' if current_user.publish_private_repos }} onchange="updatePrivacy('publish_private_repos', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Section -->
            <div class="settings-section" id="notifications-section">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2 class="settings-title">Email Notifications</h2>
                        <p class="settings-description">Choose what emails you want to receive</p>
                    </div>
                    <div class="settings-body">
                        <div class="toggle-group">
                            <div class="toggle-info">
                                <h4>Login Alerts</h4>
                                <p>Receive an email when someone logs into your account</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-input" id="email-on-login" 
                                    {{ 'checked' if current_user.email_on_login }} onchange="updateNotifications('email_on_login', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="toggle-group">
                            <div class="toggle-info">
                                <h4>Analysis Complete</h4>
                                <p>Receive an email when repository analysis is finished</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-input" id="email-on-analysis" 
                                    {{ 'checked' if current_user.email_on_analysis }} onchange="updateNotifications('email_on_analysis', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="toggle-group">
                            <div class="toggle-info">
                                <h4>Marketing & Updates</h4>
                                <p>Receive news, tips, and product updates</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-input" id="email-marketing" 
                                    {{ 'checked' if current_user.email_marketing }} onchange="updateNotifications('email_marketing', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Integrations Section -->
            <div class="settings-section" id="integrations-section">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2 class="settings-title">Integrations</h2>
                        <p class="settings-description">Manage third-party integrations</p>
                    </div>
                    <div class="settings-body">
                        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                            <i class="fas fa-plug" style="font-size: 2rem; margin-bottom: 1rem; display: block; opacity: 0.5;"></i>
                            No integrations available yet. Coming soon!
                        </p>
                    </div>
                </div>
            </div>

            <!-- Danger Zone Section -->
            <div class="settings-section" id="danger-section">
                <div class="settings-card">
                    <div class="settings-header">
                        <h2 class="settings-title" style="color: var(--error-default);">Danger Zone</h2>
                        <p class="settings-description">Irreversible and destructive actions</p>
                    </div>
                    <div class="settings-body">
                        <div class="danger-zone">
                            <div class="danger-zone-header">
                                <div>
                                    <h3 class="danger-zone-title">Delete Account</h3>
                                    <p class="danger-zone-description">Permanently delete your account and all associated data. This action cannot be undone.</p>
                                </div>
                                <button type="button" class="btn btn-danger" onclick="requestDeleteAccount()">
                                    <i class="fas fa-trash"></i> Delete Account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Email Change Modal -->
<div class="modal-overlay" id="email-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Verify Email Change</h3>
            <p class="modal-description">Enter the 6-digit verification code sent to your new email address.</p>
        </div>
        <div class="form-group">
            <label class="form-label" for="email-code">Verification Code</label>
            <input type="text" id="email-code" class="form-control" placeholder="XXXXXX" maxlength="6" style="text-transform: uppercase; letter-spacing: 3px; text-align: center; font-size: 1.25rem;">
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('email-modal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="verifyEmailChange()">Verify</button>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal-overlay" id="delete-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" style="color: var(--error-default);">Delete Your Account</h3>
            <p class="modal-description">This action <strong>cannot be undone</strong>. This will permanently delete your account, repositories, and all associated data.</p>
        </div>
        <div class="form-group">
            <label class="form-label" for="confirm-username">Type your username to confirm:</label>
            <input type="text" id="confirm-username" class="form-control" placeholder="{{ current_user.username }}">
        </div>
        <div class="form-group">
            <label class="form-label" for="delete-code">Confirmation Code (sent to your email):</label>
            <input type="text" id="delete-code" class="form-control" placeholder="XXXXXX" maxlength="6" style="text-transform: uppercase; letter-spacing: 3px;">
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('delete-modal')">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-delete-btn" onclick="confirmDeleteAccount()" disabled>
                <i class="fas fa-trash"></i> Delete Forever
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const CSRF_TOKEN = '{{ csrf_token() }}';
const CURRENT_USERNAME = '{{ current_user.username }}';

// Toast notification
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle' };
    toast.innerHTML = `
        <i class="fas ${icons[type]} toast-icon"></i>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
    `;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

// API helper
async function apiCall(endpoint, method = 'POST', data = null) {
    const options = {
        method,
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN }
    };
    if (data) options.body = JSON.stringify(data);
    const response = await fetch(`/api/settings${endpoint}`, options);
    return response.json();
}

// Navigation
document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
        document.getElementById(this.dataset.section + '-section').classList.add('active');
        history.replaceState(null, null, '#' + this.dataset.section);
    });
});

// Handle hash on load
if (window.location.hash) {
    const section = window.location.hash.slice(1);
    const link = document.querySelector(`.nav-link[data-section="${section}"]`);
    if (link) link.click();
}

// Avatar source selection
document.querySelectorAll('.avatar-source-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const source = this.dataset.source;
        const result = await apiCall('/avatar/source', 'POST', { source });
        if (result.success) {
            document.querySelectorAll('.avatar-source-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            updateAvatarPreview(result);
            showToast('Avatar updated');
        } else {
            showToast(result.error, 'error');
        }
    });
});

function updateAvatarPreview(data) {
    const preview = document.getElementById('avatar-preview');
    if (data.avatar_source === 'letter' || !data.avatar_url) {
        preview.innerHTML = CURRENT_USERNAME[0].toUpperCase();
        preview.style.background = data.letter_color || '#667eea';
    } else {
        preview.innerHTML = `<img src="${data.avatar_url}" alt="Avatar">`;
        preview.style.background = 'transparent';
    }
}

// Avatar upload
document.getElementById('avatar-input').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > 2 * 1024 * 1024) {
        showToast('File too large. Maximum size is 2MB', 'error');
        return;
    }
    const formData = new FormData();
    formData.append('avatar', file);
    const response = await fetch('/api/settings/avatar/upload', {
        method: 'POST',
        headers: { 'X-CSRFToken': CSRF_TOKEN },
        body: formData
    });
    const result = await response.json();
    if (result.success) {
        updateAvatarPreview(result);
        location.reload();
    } else {
        showToast(result.error, 'error');
    }
});

async function removeAvatar() {
    const result = await apiCall('/avatar/remove', 'POST');
    if (result.success) {
        updateAvatarPreview(result);
        document.querySelectorAll('.avatar-source-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.avatar-source-btn.letter')?.classList.add('active');
        showToast('Avatar removed');
    } else {
        showToast(result.error, 'error');
    }
}

// Username change
async function changeUsername() {
    const newUsername = document.getElementById('username').value.trim();
    if (!newUsername || newUsername === CURRENT_USERNAME) return;
    const result = await apiCall('/username', 'POST', { username: newUsername });
    if (result.success) {
        showToast('Username changed successfully');
        setTimeout(() => location.reload(), 1500);
    } else {
        showToast(result.error, 'error');
    }
}

// Email change
async function requestEmailChange() {
    const newEmail = document.getElementById('email').value.trim();
    if (!newEmail) return;
    const result = await apiCall('/email/request-change', 'POST', { email: newEmail });
    if (result.success) {
        showToast(result.message);
        openModal('email-modal');
    } else {
        showToast(result.error, 'error');
    }
}

async function verifyEmailChange() {
    const code = document.getElementById('email-code').value.trim();
    if (!code) return;
    const result = await apiCall('/email/verify', 'POST', { code });
    if (result.success) {
        showToast('Email changed successfully');
        closeModal('email-modal');
        setTimeout(() => location.reload(), 1500);
    } else {
        showToast(result.error, 'error');
    }
}

// Profile form
document.getElementById('profile-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = document.getElementById('save-profile-btn');
    btn.classList.add('btn-loading');
    btn.innerHTML = '<span class="spinner"></span> Saving...';
    const result = await apiCall('/profile', 'POST', {
        bio: document.getElementById('bio').value,
        website: document.getElementById('website').value,
        location: document.getElementById('location').value
    });
    btn.classList.remove('btn-loading');
    btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
    if (result.success) {
        showToast('Profile saved successfully');
    } else {
        showToast(result.error, 'error');
    }
});

// Bio counter
document.getElementById('bio').addEventListener('input', function() {
    document.getElementById('bio-count').textContent = this.value.length;
});

// Privacy settings
async function updatePrivacy(field, value) {
    const result = await apiCall('/privacy', 'POST', { [field]: value });
    if (result.success) {
        showToast('Privacy settings updated');
    } else {
        showToast(result.error, 'error');
        document.getElementById(field.replace('_', '-')).checked = !value;
    }
}

// Notification settings
async function updateNotifications(field, value) {
    const result = await apiCall('/notifications', 'POST', { [field]: value });
    if (result.success) {
        showToast('Notification settings updated');
    } else {
        showToast(result.error, 'error');
    }
}

// Preferences
async function updatePreference(field, value) {
    const result = await apiCall('/preferences', 'POST', { [field]: value });
    if (result.success) {
        showToast('Preferences updated');
        if (field === 'language') setTimeout(() => location.reload(), 1000);
    } else {
        showToast(result.error, 'error');
    }
}

// Delete account
async function requestDeleteAccount() {
    const result = await apiCall('/account/request-delete', 'POST');
    if (result.success) {
        showToast('Confirmation code sent to your email');
        openModal('delete-modal');
    } else {
        showToast(result.error, 'error');
    }
}

document.getElementById('confirm-username').addEventListener('input', function() {
    const deleteBtn = document.getElementById('confirm-delete-btn');
    const codeInput = document.getElementById('delete-code').value;
    deleteBtn.disabled = !(this.value === CURRENT_USERNAME && codeInput.length === 6);
});

document.getElementById('delete-code').addEventListener('input', function() {
    const deleteBtn = document.getElementById('confirm-delete-btn');
    const usernameInput = document.getElementById('confirm-username').value;
    deleteBtn.disabled = !(usernameInput === CURRENT_USERNAME && this.value.length === 6);
});

async function confirmDeleteAccount() {
    const username = document.getElementById('confirm-username').value;
    const code = document.getElementById('delete-code').value;
    const result = await apiCall('/account/confirm-delete', 'POST', { username, code });
    if (result.success) {
        showToast('Account deleted. Goodbye!');
        setTimeout(() => window.location.href = result.redirect || '/', 2000);
    } else {
        showToast(result.error, 'error');
    }
}

// Modal helpers
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('active');
    });
});
</script>
{% endblock %}