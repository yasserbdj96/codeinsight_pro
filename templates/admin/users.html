{% extends "base.html" %}

{% block title %}User Management - Admin{% endblock %}

{% block extra_css %}
<style>
.admin-container { max-width: 1400px; margin: 0 auto; }
.admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
.admin-title { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 0.75rem; }
.back-link { color: var(--text-secondary); text-decoration: none; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; }
.back-link:hover { color: var(--accent-primary); }

/* Search & Filter */
.controls-bar { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1.5rem; }
.search-box { position: relative; flex: 1; min-width: 250px; }
.search-box input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.75rem; border: 1px solid var(--border-default); border-radius: var(--radius-md); background: var(--bg-primary); color: var(--text-primary); font-size: 0.875rem; }
.search-box input:focus { outline: none; border-color: var(--accent-primary); }
.search-box i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); }
.filter-select { padding: 0.75rem 1rem; border: 1px solid var(--border-default); border-radius: var(--radius-md); background: var(--bg-primary); color: var(--text-primary); font-size: 0.875rem; min-width: 150px; }
.bulk-actions { display: flex; gap: 0.5rem; }
.btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1rem; font-size: 0.875rem; font-weight: 600; border-radius: var(--radius-md); border: 1px solid transparent; cursor: pointer; transition: all 0.2s; text-decoration: none; }
.btn-primary { background: var(--accent-primary); color: #fff; }
.btn-primary:hover { background: var(--accent-emphasis); }
.btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-default); }
.btn-secondary:hover { background: var(--bg-tertiary); }
.btn-danger { background: var(--error-default); color: #fff; }
.btn-danger:hover { background: #b91c1c; }
.btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* Table */
.users-card { background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: var(--radius-lg); overflow: hidden; }
.users-table { width: 100%; border-collapse: collapse; }
.users-table th { text-align: left; padding: 1rem; font-size: 0.75rem; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-subtle); }
.users-table td { padding: 1rem; border-bottom: 1px solid var(--border-subtle); vertical-align: middle; }
.users-table tr:hover { background: var(--bg-secondary); }
.users-table tr:last-child td { border-bottom: none; }

.user-cell { display: flex; align-items: center; gap: 0.875rem; }
.user-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #fff; font-size: 1rem; flex-shrink: 0; overflow: hidden; }
.user-avatar img { width: 100%; height: 100%; object-fit: cover; }
.user-details { min-width: 0; }
.user-name { font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-email { font-size: 0.8125rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.provider-icons i { margin-right: 0.375rem; font-size: 1rem; }
.provider-icons .fa-github { color: var(--text-primary); }
.provider-icons .fa-gitlab { color: #fc6d26; }
.provider-icons .fa-bitbucket { color: #0052CC; }

.badge { display: inline-block; padding: 0.25rem 0.5rem; font-size: 0.6875rem; font-weight: 600; border-radius: 1rem; text-transform: uppercase; margin-right: 0.25rem; }
.badge-admin { background: #fef3c7; color: #d97706; }
.badge-premium { background: #dbeafe; color: #2563eb; }
.badge-verified { background: #d1fae5; color: #059669; }
.badge-banned { background: #fee2e2; color: #dc2626; }
[data-theme="dark"] .badge-admin { background: #78350f; color: #fcd34d; }
[data-theme="dark"] .badge-premium { background: #1e40af; color: #93c5fd; }
[data-theme="dark"] .badge-verified { background: #065f46; color: #6ee7b7; }
[data-theme="dark"] .badge-banned { background: #7f1d1d; color: #fca5a5; }

.actions-cell { display: flex; gap: 0.375rem; }
.action-btn { padding: 0.375rem 0.5rem; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; border-radius: var(--radius-sm); transition: all 0.2s; }
.action-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
.action-btn.danger:hover { background: var(--error-muted); color: var(--error-default); }

.checkbox-cell { width: 40px; }
.checkbox-cell input { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent-primary); }

/* Pagination */
.pagination { display: flex; justify-content: center; align-items: center; gap: 0.5rem; padding: 1.5rem; }
.page-btn { padding: 0.5rem 0.875rem; border: 1px solid var(--border-default); background: var(--bg-primary); color: var(--text-primary); border-radius: var(--radius-md); cursor: pointer; font-size: 0.875rem; transition: all 0.2s; text-decoration: none; }
.page-btn:hover { background: var(--bg-secondary); }
.page-btn.active { background: var(--accent-primary); color: #fff; border-color: var(--accent-primary); }
.page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.page-info { color: var(--text-secondary); font-size: 0.875rem; margin: 0 1rem; }

/* Modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 10000; padding: 1rem; backdrop-filter: blur(4px); }
.modal-overlay.active { display: flex; }
.modal { background: var(--bg-primary); border-radius: var(--radius-lg); max-width: 500px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; animation: modalIn 0.2s ease-out; }
@keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
.modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; }
.modal-title { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); }
.modal-close { background: none; border: none; color: var(--text-tertiary); cursor: pointer; font-size: 1.25rem; padding: 0.25rem; }
.modal-close:hover { color: var(--text-primary); }
.modal-body { padding: 1.5rem; overflow-y: auto; }
.modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-subtle); display: flex; justify-content: flex-end; gap: 0.75rem; }

.form-group { margin-bottom: 1.25rem; }
.form-group:last-child { margin-bottom: 0; }
.form-label { display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; }
.form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--border-default); border-radius: var(--radius-md); background: var(--bg-primary); color: var(--text-primary); font-size: 0.875rem; }
.form-control:focus { outline: none; border-color: var(--accent-primary); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

.toggle-group { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: 0.75rem; }
.toggle-label { font-size: 0.875rem; font-weight: 500; color: var(--text-primary); }
.toggle-switch { position: relative; width: 44px; height: 24px; }
.toggle-input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; cursor: pointer; inset: 0; background: var(--border-default); border-radius: 24px; transition: 0.3s; }
.toggle-slider::before { content: ''; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.3s; }
.toggle-input:checked + .toggle-slider { background: var(--accent-primary); }
.toggle-input:checked + .toggle-slider::before { transform: translateX(20px); }

/* Toast */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 0.75rem; }
.toast { display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); min-width: 280px; animation: toastIn 0.3s; }
@keyframes toastIn { from { opacity: 0; transform: translateX(100%); } }
.toast.success { border-left: 4px solid var(--success-default); }
.toast.error { border-left: 4px solid var(--error-default); }

/* Empty State */
.empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-tertiary); }
.empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
.empty-state p { font-size: 1rem; }

@media (max-width: 768px) {
    .controls-bar { flex-direction: column; align-items: stretch; }
    .search-box { min-width: 100%; }
    .users-table { display: block; overflow-x: auto; }
    .form-row { grid-template-columns: 1fr; }
}

.btn-success {
    background: var(--success-default);
    color: #fff;
}
.btn-success:hover {
    background: var(--success-emphasis);
}
</style>
{% endblock %}

{% block content %}
<div class="toast-container" id="toast-container"></div>

<div class="admin-container">
    <div class="admin-header">
        <div>
            <a href="{{ url_for('admin.dashboard') }}" class="back-link"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
            <h1 class="admin-title"><i class="fas fa-users"></i> User Management</h1>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Search users by name or email..." value="{{ search }}">
        </div>
        <select class="filter-select" id="filter-select">
            <option value="all" {{ 'selected' if filter_type == 'all' }}>All Users</option>
            <option value="premium" {{ 'selected' if filter_type == 'premium' }}>Premium</option>
            <option value="admin" {{ 'selected' if filter_type == 'admin' }}>Admins</option>
            <option value="github" {{ 'selected' if filter_type == 'github' }}>GitHub</option>
            <option value="gitlab" {{ 'selected' if filter_type == 'gitlab' }}>GitLab</option>
            <option value="bitbucket" {{ 'selected' if filter_type == 'bitbucket' }}>Bitbucket</option>
            <option value="banned" {{ 'selected' if filter_type == 'banned' }}>Banned users</option>
        </select>
        <div class="bulk-actions">
            <button class="btn btn-secondary btn-sm" id="bulk-premium-btn" disabled onclick="bulkAction('make_premium')"><i class="fas fa-crown"></i> Make Premium</button>
            <button class="btn btn-secondary btn-sm" id="bulk-remove-premium-btn" disabled onclick="bulkAction('remove_premium')"><i class="fas fa-crown"></i> Remove Premium</button>
            <button class="btn btn-secondary btn-sm" id="bulk-verify-btn" disabled onclick="bulkAction('verify')"><i class="fas fa-check"></i> Verify</button>
            <button class="btn btn-danger btn-sm" id="bulk-ban-btn" disabled onclick="bulkAction('ban')"><i class="fas fa-ban"></i> Ban</button>
            <button class="btn btn-secondary btn-sm" id="bulk-unban-btn" disabled onclick="bulkAction('unban')"><i class="fas fa-undo"></i> Unban</button>
        </div>
    </div>

    <!-- Users Table -->
    <div class="users-card">
        {% if users.items %}
        <table class="users-table">
            <thead>
                <tr>
                    <th class="checkbox-cell"><input type="checkbox" id="select-all" onchange="toggleSelectAll(this)"></th>
                    <th>User</th>
                    <th>Provider</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users.items %}
                <tr data-user-id="{{ user.id }}">
                    <td class="checkbox-cell">
                        <input type="checkbox" class="user-checkbox" value="{{ user.id }}" onchange="updateBulkButtons()" {{ 'disabled' if user.id == current_user.id }}>
                    </td>
                    <td>
                        <div class="user-cell">
                            <div class="user-avatar" style="background: {{ user.get_letter_avatar_color() }};">
                                {% if user.avatar_url %}<img src="{{ user.avatar_url }}">{% else %}{{ user.username[0].upper() }}{% endif %}
                            </div>
                            <div class="user-details">
                                <div class="user-name">{{ user.username }}</div>
                                <div class="user-email">{{ user.email or 'No email' }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="provider-icons">
                        {% if user.github_id %}<i class="fab fa-github" title="GitHub"></i>{% endif %}
                        {% if user.gitlab_id %}<i class="fab fa-gitlab" title="GitLab"></i>{% endif %}
                        {% if user.bitbucket_id %}<i class="fab fa-bitbucket" title="Bitbucket"></i>{% endif %}
                    </td>
                    <td>
                        {% if user.deleted_at %}<span class="badge badge-banned">Banned</span>{% endif %}
                        {% if user.is_admin %}<span class="badge badge-admin">Admin</span>{% endif %}
                        {% if user.is_premium %}<span class="badge badge-premium">Premium</span>{% endif %}
                        {% if user.is_verified %}<span class="badge badge-verified">Verified</span>{% endif %}
                    </td>
                    <td style="color: var(--text-secondary); font-size: 0.8125rem;">{{ user.created_at.strftime('%b %d, %Y') }}</td>
                    <td>
                        <div class="actions-cell">
                            <button class="action-btn" onclick="editUser({{ user.id }})" title="Edit"><i class="fas fa-edit"></i></button>
                            {% if user.id != current_user.id %}
                                {% if user.deleted_at %}
                                <button class="action-btn" onclick="unbanUser({{ user.id }})" title="Unban"><i class="fas fa-undo"></i></button>
                                {% else %}
                                <button class="action-btn" onclick="impersonateUser({{ user.id }})" title="Impersonate"><i class="fas fa-user-secret"></i></button>
                                <button class="action-btn danger" onclick="banUser({{ user.id }})" title="Ban"><i class="fas fa-ban"></i></button>
                                {% endif %}
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Pagination -->
        {% if users.pages > 1 %}
        <div class="pagination">
            {% if users.has_prev %}
            <a href="?page={{ users.prev_num }}&search={{ search }}&filter={{ filter_type }}" class="page-btn"><i class="fas fa-chevron-left"></i></a>
            {% endif %}
            
            {% for page_num in users.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                <a href="?page={{ page_num }}&search={{ search }}&filter={{ filter_type }}" class="page-btn {{ 'active' if page_num == users.page }}">{{ page_num }}</a>
                {% else %}
                <span class="page-info">...</span>
                {% endif %}
            {% endfor %}
            
            {% if users.has_next %}
            <a href="?page={{ users.next_num }}&search={{ search }}&filter={{ filter_type }}" class="page-btn"><i class="fas fa-chevron-right"></i></a>
            {% endif %}
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <i class="fas fa-users"></i>
            <p>No users found</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal-overlay" id="edit-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Edit User</h3>
            <button class="modal-close" onclick="closeModal('edit-modal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-user-id">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="edit-username" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="edit-email" class="form-control">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Roles & Status</label>
                <div class="toggle-group">
                    <span class="toggle-label">Administrator</span>
                    <label class="toggle-switch"><input type="checkbox" class="toggle-input" id="edit-admin"><span class="toggle-slider"></span></label>
                </div>
                <div class="toggle-group">
                    <span class="toggle-label">Premium</span>
                    <label class="toggle-switch"><input type="checkbox" class="toggle-input" id="edit-premium"><span class="toggle-slider"></span></label>
                </div>
                <div class="toggle-group">
                    <span class="toggle-label">Verified</span>
                    <label class="toggle-switch"><input type="checkbox" class="toggle-input" id="edit-verified"><span class="toggle-slider"></span></label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('edit-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveUser()"><i class="fas fa-save"></i> Save Changes</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const CSRF_TOKEN = '{{ csrf_token() }}';
let searchTimeout;

function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i><span>${message}</span>`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

async function apiCall(endpoint, method = 'POST', data = null) {
    const options = { method, headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN } };
    if (data) options.body = JSON.stringify(data);
    const response = await fetch(endpoint, options);
    return response.json();
}

// Search & Filter
document.getElementById('search-input').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const search = this.value;
        const filter = document.getElementById('filter-select').value;
        window.location.href = `?search=${encodeURIComponent(search)}&filter=${filter}`;
    }, 500);
});

document.getElementById('filter-select').addEventListener('change', function() {
    const search = document.getElementById('search-input').value;
    window.location.href = `?search=${encodeURIComponent(search)}&filter=${this.value}`;
});

// Selection
function toggleSelectAll(checkbox) {
    document.querySelectorAll('.user-checkbox:not(:disabled)').forEach(cb => cb.checked = checkbox.checked);
    updateBulkButtons();
}

function updateBulkButtons() {
    const selected = document.querySelectorAll('.user-checkbox:checked').length;
    document.getElementById('bulk-premium-btn').disabled = selected === 0;
    document.getElementById('bulk-ban-btn').disabled = selected === 0;
}

function getSelectedUserIds() {
    return Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => parseInt(cb.value));
}

// User Actions
async function editUser(userId) {
    const result = await apiCall(`/admin/api/users/${userId}`, 'GET');
    if (result.success) {
        const user = result.user;
        document.getElementById('edit-user-id').value = userId;
        document.getElementById('edit-username').value = user.username;
        document.getElementById('edit-email').value = user.email || '';
        document.getElementById('edit-admin').checked = user.is_admin;
        document.getElementById('edit-premium').checked = user.is_premium;
        document.getElementById('edit-verified').checked = user.is_verified;
        openModal('edit-modal');
    } else {
        showToast(result.error, 'error');
    }
}

async function saveUser() {
    const userId = document.getElementById('edit-user-id').value;
    const data = {
        username: document.getElementById('edit-username').value,
        email: document.getElementById('edit-email').value,
        is_admin: document.getElementById('edit-admin').checked,
        is_premium: document.getElementById('edit-premium').checked,
        is_verified: document.getElementById('edit-verified').checked
    };
    const result = await apiCall(`/admin/api/users/${userId}`, 'PUT', data);
    if (result.success) {
        showToast('User updated successfully');
        closeModal('edit-modal');
        setTimeout(() => location.reload(), 1000);
    } else {
        showToast(result.error, 'error');
    }
}

async function banUser(userId) {
    if (!confirm('Are you sure you want to ban this user?')) return;
    const result = await apiCall(`/admin/api/users/${userId}/ban`, 'POST');
    if (result.success) {
        showToast('User banned');
        setTimeout(() => location.reload(), 1000);
    } else {
        showToast(result.error, 'error');
    }
}

async function unbanUser(userId) {
    const result = await apiCall(`/admin/api/users/${userId}/unban`, 'POST');
    if (result.success) {
        showToast('User unbanned');
        setTimeout(() => location.reload(), 1000);
    } else {
        showToast(result.error, 'error');
    }
}

async function impersonateUser(userId) {
    if (!confirm('Login as this user? You will be logged out of your admin account.')) return;
    const result = await apiCall(`/admin/api/users/${userId}/impersonate`, 'POST');
    if (result.success) {
        window.location.href = result.redirect;
    } else {
        showToast(result.error, 'error');
    }
}

async function bulkAction(action) {
    const userIds = getSelectedUserIds();
    if (userIds.length === 0) return;
    if (!confirm(`Apply "${action}" to ${userIds.length} users?`)) return;
    const result = await apiCall('/admin/api/users/bulk', 'POST', { action, user_ids: userIds });
    if (result.success) {
        showToast(result.message);
        setTimeout(() => location.reload(), 1000);
    } else {
        showToast(result.error, 'error');
    }
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); }));

// Update bulk buttons based on filter
function updateBulkButtonsByFilter() {
    const filter = document.getElementById('filter-select').value;
    const banBtn = document.getElementById('bulk-ban-btn');
    const unbanBtn = document.getElementById('bulk-unban-btn');
    
    if (filter === 'banned') {
        banBtn.style.display = 'none';
        unbanBtn.style.display = 'inline-flex';
    } else {
        banBtn.style.display = 'inline-flex';
        unbanBtn.style.display = 'none';
    }
}

// Call this when page loads and when filter changes
document.addEventListener('DOMContentLoaded', function() {
    updateBulkButtonsByFilter();
    document.getElementById('filter-select').addEventListener('change', updateBulkButtonsByFilter);
});
</script>
{% endblock %}